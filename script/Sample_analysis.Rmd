---
title: "Sample_analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Import libraries
```{r}
library(Seurat)
library(tximport)
library(ggplot2)
```

Create table with the names of the samples
```{r}
samples <- matrix(c("SRR8257100",
"SRR8257101",
"SRR8257102",
"SRR8257103",
"SRR8257104",
"SRR8257105",
"SRR8257106"), ncol=1, byrow=TRUE)
samples<-as.table(samples)
samples
```

Retrieving data to analyze
```{r}
files <- file.path(
  paste("~/mydatalocal/tp_ngs_scarabi/data/Alevin_complete/quant/",samples,"/alevin/quants_mat.gz", sep=""))
file.exists(files)
```

A list containing a matrix for every sample. The matrix contains the gene count for every cell
```{r}
txis <- lapply(files, function(f) tximport(files = f, type="alevin"))
```

Creating Seurat obkects
```{r}
seu_objs <- lapply(seq_along(txis), function(i){
  s <- CreateSeuratObject(counts = txis[[i]]$counts , min.cells = 3, min.features = 200, project = samples[i]) 
  })


scarabWT <- merge(x = seu_objs[[1]], y = unlist(seu_objs[2:4], recursive = F), add.cell.ids = samples[1:4])
```


QC and selecting cells for further analysis
```{r}
scarabWT[["percent.mt"]] <- PercentageFeatureSet(scarabWT, pattern = "ATM")
scarabWT[["percent.chloro"]] <- PercentageFeatureSet(scarabWT, pattern = "ATC")
```

```{r}
VlnPlot(scarabWT, features = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.chloro"), ncol = 4)
```

```{r}
quant<-quantile(scarabWT[["percent.mt"]]$percent.m, 0.95)
```

Selection des cellules remplissant certaines conditions :
Les 95% de cellules ayant le pourcentage de gènes mitochondriaux les plus bas
Les cellules ayant moins de 0,2% de gènes chloroplastiques 
```{r}
scarabWT <- subset(scarabWT, subset = percent.mt < quant & percent.chloro<0.2)
```

```{r}
VlnPlot(scarabWT, features = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.chloro"), ncol = 4)
```
Nombre de cellules par échantillon
```{r}
table(scarabWT$orig.ident)
```

Normalizing the data
```{r}
scarabWT <- NormalizeData(scarabWT, normalization.method = "LogNormalize", scale.factor = 10000)
#scale factor : facteur multiplicatif pour que les résultats soient plus faciles à lire
```

Selection of the highly variable genes. Threshhold at 8000 
```{r}
scarabWT <- FindVariableFeatures(scarabWT, selection.method = "vst", nfeatures = 8000)
```

Scaling the data
```{r}
all.genes <- rownames(scarabWT)
scarabWT <- ScaleData(scarabWT, features = all.genes)
```


Performing PCA 
```{r}
scarabWT <- RunPCA(scarabWT, features = VariableFeatures(object = scarabWT))
```
Visualization of PCA results
```{r}
print(scarabWT[["pca"]], dims = 1:5, nfeatures = 5)
VizDimLoadings(scarabWT, dims = 1:2, reduction = "pca")
```

```{r}
DimPlot(scarabWT, reduction = "pca")

```

```{r}
DimHeatmap(scarabWT, dims = 1:15, cells = 500, balanced = TRUE)
```

JackStraw
```{r}
#scarabWT <- JackStraw(scarabWT, num.replicate = 100)
#scarabWT <- ScoreJackStraw(scarabWT, dims = 1:20)
```


```{r}
ElbowPlot(scarabWT)
```
Neighbors : remplit un graphe avec distance entre cellules
Clusters : couper le graphe pour obtenir des paquets
UMAP : representation de ça. Garde le 
```{r}
scarabWT <- FindNeighbors(scarabWT, dims = 1:10)
scarabWT <- FindClusters(scarabWT, resolution = 0.5)
```

```{r}
scarabWT <- RunUMAP(scarabWT, dims = 1:10)
```
```{r}
umapplot<-DimPlot(scarabWT, reduction = "umap")
ggsave(umapplot,file="~/mydatalocal/tp_ngs_scarabi/results/Featureplot/umap.png",width=20,height=20,units="cm") 
```

Import markers
```{r}
markers<-read.table("~/mydatalocal/tp_ngs_scarabi/data/Markers.csv",sep="\t",h=T)
markers
```


```{r}

markers$Locus<-gsub(" ","",markers$Locus)
markers$Preferential.expression.in.root<-gsub(" ","",markers$Preferential.expression.in.root)
#pour retires les espaces en trop dans le nom des features
```


```{r}

markers$Preferential.expression.in.root<-gsub("/"," ",markers$Preferential.expression.in.root) #on retire les slash du nom du cell type parce que l'ordinateur va penser que c'est un path
celltypes<-unique(markers$Preferential.expression.in.root)
celltypes
```


```{r}


sapply(celltypes,function(x){
  
  f<-FeaturePlot(scarabWT, features = markers[markers$Preferential.expression.in.root==x,]$Locus)
  ggsave(f,file=paste0("~/mydatalocal/tp_ngs_scarabi/results/Featureplot/",x,".png"),width=40,height=40,units="cm") 
})

```

Creates a file with the combined expression of the top markers of each cell type 
```{r}

datascore<- data.frame(sapply(celltypes,function(x){ 
  
  gene<-markers[markers$Preferential.expression.in.root==x,]$Locus
  
  score=colMeans(scarabWT@assays$RNA[gene,])}))
names(datascore)<-make.names(celltypes)
scarabWT <- AddMetaData(scarabWT, metadata = datascore)
g<-FeaturePlot(scarabWT, features=names(datascore))
ggsave(g,file = "~/mydatalocal/tp_ngs_scarabi/results/Featureplot/combined_umap.png",width=40,height=40,units="cm")
```



