---
title: "Sample_analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Import libraries
```{r}
library(Seurat)
library(tximport)
```

Create table with the names of the samples
```{r}
samples <- matrix(c("SRR8257100",
"SRR8257101",
"SRR8257102",
"SRR8257103",
"SRR8257104",
"SRR8257105",
"SRR8257106"), ncol=1, byrow=TRUE)
samples<-as.table(samples)
samples
```

Retrieving data to analyze
```{r}
files <- file.path(
  paste("~/mydatalocal/tp_ngs_scarabi/data/Alevin_complete/quant/",samples,"/alevin/quants_mat.gz", sep=""))
file.exists(files)
```

A list containing a matrix for every sample. The matrix contains the gene count for every cell
```{r}
txis <- lapply(files, function(f) tximport(files = f, type="alevin"))
```

Creating Seurat obkects
```{r}
seu_objs <- lapply(seq_along(txis), function(i){
  s <- CreateSeuratObject(counts = txis[[i]]$counts , min.cells = 3, min.features = 200, project = samples[i]) 
  })


scarabWT <- merge(x = seu_objs[[1]], y = unlist(seu_objs[2:4], recursive = F), add.cell.ids = samples[1:4])
```


QC and selecting cells for further analysis
```{r}
scarabWT[["percent.mt"]] <- PercentageFeatureSet(scarabWT, pattern = "ATM")
scarabWT[["percent.chloro"]] <- PercentageFeatureSet(scarabWT, pattern = "ATC")
```

```{r}
VlnPlot(scarabWT, features = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.chloro"), ncol = 4)
```

```{r}
quant<-quantile(scarabWT[["percent.mt"]]$percent.m, 0.95)
```

Selection des cellules remplissant certaines conditions :
Les 95% de cellules ayant le pourcentage de gènes mitochondriaux les plus bas
Les cellules ayant moins de 0,2% de gènes chloroplastiques 
```{r}
scarabWT <- subset(scarabWT, subset = percent.mt < quant & percent.chloro<0.2)
```

```{r}
VlnPlot(scarabWT, features = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.chloro"), ncol = 4)
```
Nombre de cellules par échantillon
```{r}
table(scarabWT$orig.ident)
```

Normalizing the data 
```{r}
scarabWT <- NormalizeData(scarabWT, normalization.method = "LogNormalize", scale.factor = 10000)
#scale factor : facteur multiplicatif pour que les résultats soient plus faciles à lire
```

